title:科大虚拟仿真实验中心
disc:湖南科技大学虚拟仿真实验教学中心门户网
type:项目经历
------------------
####页面效果: [http://vlab.hnust.edu.cn/](http://vlab.hnust.edu.cn/)

首页看起来像这样
![vlab](post/img/vlab2.jpg)

后台看起来像这样
![vlab](post/img/vlab3.jpg)

本来以为是一个不急的任务,可以慢慢撸,说好20天做好给1K,没相到能源学院那边领导急的不行,居然妄想
三天做好一个完整的CMS.

没办法,任务下来了,迫于领导压力还是要没命赶快撸啊,

这是刚开始顺手写的一个静态demo [http://1.hnustvlab.sinaapp.com/](http://1.hnustvlab.sinaapp.com/)
![vlab](post/img/vlab1.jpg)

领导不是很满意说看起来太空洞,内容太少,我丢！ (╯‵□′)╯︵┻━┻,啥内容我都没有也是无奈.
时间又紧,于是乎按领导要求直接趴了厦大虚拟仿真中心的首页（个人觉得丑的一逼,但是图省事,算了）.然后开始写后台.本打算直接用织梦,我没玩过那玩意儿,安装过后感觉一阵阵恶心,算了,感觉用这个我三天都做不出个影子来.直接捡起我多年没碰的PHP...开撸！.

第一个晚上用 PHP 写了个 API ,把操作都放到前端.
adminDataAPI.php: 

使用POST发送和接受数据;

获取数据:  `query`: 要获取的表单; `id`: 要获取的行ID(`'all'`获取全部, `'first'`获取第一条, `'last'`获取最后一条), `field`: 要获取的字段(为空则获取全部); 返回json,无需登录.

发送数据:  `save`: 要保存的表单; `id`: 要保存的行ID(`'no'` 表示新增), 需登录之后才接受操作, 成功返回`success`.

删除数据:  `delete`: 要删除的表单; `id`: 要删除的行ID, 需登录之后才接受操作, 成功返回`success`.

    <?php
    session_start();
    //可访问表单控制
    $allowed = array('vlab_disc', 'vlab_resource', 'vlab_news', 'vlab_message', 'vlab_rule',
     'vlab_major', 'vlab_teacher', 'vlab_title', 'vlab_device', 'vlab_degree');

        //获取数据可以无需登录
    if(isset($_POST['query']) && isset($_POST['id'])){
        include('connDB.php');
        $q = $_POST['query'];
        $id = $_POST['id'];
        if(in_array($q, $allowed)) {
            $field = '*';
            if(!isset($_POST['field']))
            {   
                $field = '';
                print_r($_POST['field']);
                foreach ($_POST['field'] as $key => $value) {
                    $field .= $value . ' ';
                }
            }
            if($id == 'all'){
                //获取整个表单的数据
                $query = "SELECT $field FROM $q";
                $result = $pdo -> prepare($query);
            }else if($id == 'last'){
                //获取最后一行数据
                $query = "SELECT $field FROM $q WHERE id IN (SELECT MAX(id) FROM $q )";
                $result = $pdo -> prepare($query);
            }else{
                //获取指定行的数据
                $query = "SELECT $field FROM $q WHERE id = ?";
                $result = $pdo -> prepare($query);
                $result -> bindParam(1,$id);
            }
            //echo $query;
            if(!$result -> execute()) {
                echo '获取数据失败！';
                exit();
            }
            else{
                $row = $result -> fetchAll();
                //print_r($row);
                echo json_encode($row);
            }
        }
            //若处于登录状态,则可以进行数据的修改
    }else if(isset($_POST['save']) && isset($_POST['id']) && isset($_POST['data']) && isset($_SESSION['user'])){
        include('connDB.php');
        $save = $_POST['save'];
        $id = $_POST['id'];
        $data = $_POST['data'];
        if(in_array($save, $allowed)){
                //若未指定id则新增数据
            if($id == 'no'){
                //拼凑SQL语句
                $query = "insert into " . $save . "(";
                $value = " value(";
                $length = count($data);
                $i = 1;
                foreach($data as $key => $v) {
                    if($i < $length){
                        $query .= $key . ','; $value .= '?,';
                    }
                    else {
                        $query .= $key . ')'; $value .= '?)';
                    }
                    $i++;
                }
                $query .= $value;
                //echo $query;
                $result = $pdo -> prepare($query);
                $i = 1;
                foreach($data as $key => $v) {
                    //此处必须绑定$data[$key],若绑定$v则所有绑定值都相同
                    $result -> bindParam($i,$data[$key]);
                    $i++;
                }
                if(!$result -> execute())
                    echo 'sql查询失败';
                else
                    echo 'success';
            }
            else{
                $query = "update ". $save . " set ";
                $i = 1;
                $length = count($data);
                foreach($data as $key => $v) {
                    if($i < $length){
                        $query .= $key . '=?,';
                    }
                    else {
                        $query .= $key . '=? where id =' . $id;
                    }
                    $i++;
                }
                //echo $query;
                $result = $pdo -> prepare($query);
                $i = 1;
                foreach($data as $key => $v) {
                    //此处必须绑定$data[$key],若绑定$v则所有绑定值都相同
                    $result -> bindParam($i,$data[$key]);
                    $i++;
                }
                if(!$result -> execute())
                    echo 'sql更新失败';
                else
                    echo 'success';
            }

        }
        //若处于登录状态,可删除数据.
    }else if(isset($_POST['delete']) && isset($_POST['id']) && isset($_SESSION['user'])){
        include('connDB.php');
        $delete = $_POST['delete'];
        $id = $_POST['id'];
        if(in_array($delete, $allowed)){
            $query = "DELETE FROM $delete WHERE id = $id";
            //echo $query;
            $result = $pdo -> prepare($query);
            if(!$result -> execute())
                echo 'sql删除失败';
            else
                echo 'success';
        }
    }else {
        echo "请输入正确的参数";
    }
    ?>

PHP水平太渣,写的实在扭曲.

JS插件`transfer.js` 用于交互数据: 

API: 

获取数据: `transfer.getText(query, id, field, fn(data))`; `query`: 要获取的表单; `id`: 要获取的字段ID(`'all'`获取全部, `'first'`获取第一条, `'last'`获取最后一条), `fn`: 回调函数(`data`为返回数据), `field`: 要获取的字段(为空则获取全部).

发送数据: `transfer.sendText(save, id, data)`; `save`: 要保存的表单; `id`: 要保存的字段ID(`'no'` 表示新增), `data`: 发送的数据.

删除数据: `transfer.deleteText(deleteTable, id)`; `deleteTable`: 要删除的表单; `id`: 要删除的字段ID, 需登录之后才接受操作, 成功返回`success`.

    $(function(){
        //发送数据
        if(window.transfer)
            throw "变量名冲突: 请检查是transfer变量是否被占用";
        
        window.transfer = function(){
            return {
                sendText : function(save, id, data) {
                        $.ajax({
                            type:"post",
                            url:"adminDataAPI.php",
                            data:{'save':save, 'id':id, 'data':data},
                            dataType:"text",
                            success:function(ret){
                                if(ret === 'success'){
                                    alert("更新成功");
                                    window.location.reload()
                                }else{
                                    alert("更新失败");
                                }
                            },
                            error:function(ret){
                                alert("网络故障,稍后重试 " + ret);
                            }
                        });
                    },
                //获取数据
                getText : function(query, id, field, fn) {
                    field = field || '';
                    var data;
                    $.ajax({
                            type:"post",
                            url:"adminDataAPI.php",
                            data:{'query':query, 'id':id, 'field':field},
                            dataType:"text",
                            success:function(ret){
                                //console.log(ret);
                                data = JSON.parse(ret);
                                fn(data);
                            },
                            error:function(ret){
                                alert("网络故障,稍后重试 " + ret);
                            }
                    });
                    return data;
                },
                //删除数据
                deleteText : function(deleteTable, id) {
                    $.ajax({
                            type:"post",
                            url:"adminDataAPI.php",
                            data:{'delete':deleteTable, 'id':id},
                            dataType:"text",
                            success:function(ret){
                                if(ret === 'success'){
                                    alert("删除成功");
                                    window.location.reload()
                                }else{
                                    alert("删除失败");
                                }
                            },
                            error:function(ret){
                                alert("网络故障,稍后重试 " + ret);
                            }
                    });
                }
            }
        }
    });